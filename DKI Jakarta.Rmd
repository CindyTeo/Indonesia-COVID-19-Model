---
title: "glm DKI Jakarta - skripsi"
author: "cindy 01112180008"
date: "9/19/2021"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

``````{r, echo=TRUE}
library(dplyr)
library(faraway)
library(MASS)
library(Metrics)
library(car)
library(AER)
library(readxl)
library(writexl)
```

# masukin and split data
``````{r, echo=TRUE}
data = DKI_Jakarta
data=within(data,{
  rm(Tanggal)
})
data=rename(data, "kelembapan rata-rata lag 27"="kelembapan lag 27")
data=rename(data, "lama penyinaran matahari lag 27"="matahari lag 27")
data=rename(data, "retail & recreation change from baseline lag 0"="retail recreation lag 0")
data=rename(data, "grocery & pharmacy  change from baseline lag 0"="grocery pharmacy lag 0")
data=rename(data, "parks change from baseline lag 16"="parks lag 16")
data=rename(data, "transit stations change from baseline lag 0"="transit stations lag 0")
data=rename(data, "workplaces change from baseline lag 12"="workplaces lag 12")
data=rename(data, "residential change from baseline lag 0"="residential lag 0")
# split data
set.seed(1)
data_size=0.8*nrow(data)
sample <- sample.int(n = nrow(data), data_size, replace = F)
dki_train=data[sample,]
dki_test=data[-sample,]
dki_train
dki_test
#export file data train to excel
write.csv(dki_train, "file:///Users/cindyteo/Desktop/dki_train.csv")
```

``````{r, echo=TRUE}
poisson_dki_train = glm(dki_train$Penambahan_Harian_Kasus_Terkonf~., family=poisson(link="log"), data = dki_train)
summary(poisson_dki_train)
# poisson glm untuk data training
```

# melihat VIF untuk mengetahui variabel mana yang berkorelasi tinggi (multikolinearitas)
``````{r, echo=TRUE}
vif(poisson_dki_train)
# tidak ada variabel dengan VIF > 10, tidak ada variabel yang multikolinearitas. semua variabel digunakan untuk memodelkan glm
```

# mengecek apakah ada overdispersion pada poisson glm dengan pearson goodness of fit
``````{r, echo=TRUE}
pearson.gof = sum(poisson_dki_train$weights*poisson_dki_train$residuals^2)
tab = data.frame(GoF.Statistic=c(poisson_dki_train$deviance,pearson.gof))
tab$DF = rep(poisson_dki_train$df.residual,2)
tab$P.Value=pchisq(tab$GoF,df=tab$DF,lower.tail = FALSE)
row.names(tab) = c("Deviance","Pearson")
print(tab)

# dispersiontest(poisson_dki_train,trafo=1) -> Here we clearly see that there is evidence of overdispersion (c is estimated to be 520.5068) which speaks quite strongly against the assumption of equidispersion (i.e. c=0).
```

``````{r,echo=TRUE}
x2 = sum(residuals(poisson_dki_train, type="pearson")^2)
c(Df=df.residual(poisson_dki_train), resid.dev=deviance(poisson_dki_train),peason.x2 = x2)
pchisq(deviance(poisson_dki_train),df.residual(poisson_dki_train),lower.tail=FALSE)
deviance(poisson_dki_train)/df.residual(poisson_dki_train)
# residual deviance & pearson goodness-of-fit > residual df -> data overdispersi (model yang dipake tidak sesuai)
# p-value = 0 -> reject goodness of fit test, model ga sesuai
```

# model negative binomial
``````{r, echo=TRUE}
nb_dki_train = glm.nb(dki_train$Penambahan_Harian_Kasus_Terkonf~., data = dki_train, control=glm.control(maxit=200))
summary(nb_dki_train)
vif(nb_dki_train)
# odTest(nb_dki_train) -> Here the null of the Poisson restriction is rejected in favour of my negative binomial regression because the test statistic 79644.5695 exceeds 2.7055 with a p-value of < 2.2e-16.
```

# membuat model tanpa variabel dengan VIF > 10
``````{r, echo=TRUE}
nb_dki_train_2=glm.nb(dki_train$Penambahan_Harian_Kasus_Terkonf~.-`transit stations change from baseline lag 0`  ,data=dki_train, control=glm.control(maxit=500))
summary(nb_dki_train_2)
vif(nb_dki_train_2)
```

``````{r, echo=TRUE}
nb_dki_train_3=glm.nb(dki_train$Penambahan_Harian_Kasus_Terkonf~.-`residential change from baseline lag 0`,data=dki_train, control=glm.control(maxit=500))
summary(nb_dki_train_3)
vif(nb_dki_train_3)
```

``````{r, echo=TRUE}
nb_dki_train_4=glm.nb(dki_train$Penambahan_Harian_Kasus_Terkonf~.-`retail & recreation change from baseline lag 0`,data=dki_train, control=glm.control(maxit=500))
summary(nb_dki_train_4)
vif(nb_dki_train_4)
```
# backward selection
``````{r, echo=TRUE}
nb_dki_train_5= stepAIC(nb_dki_train_2, direction = c("backward"), control=glm.control(maxit=3000), trace = FALSE)
summary(nb_dki_train_5)
vif(nb_dki_train_5)
```
``````{r, echo=TRUE}
exp(13.538214)
exp(-0.107624)
exp(0.069539)
exp(0.013238)
exp(-0.010334)
```
# predict dengan model glm
``````{r, echo=TRUE}
dki_test$prediction = as.integer(predict(nb_dki_train_5, newdata=dki_test, type="response"))
dki_test
```

# mencari MAE dari model glm
``````{r, echo=TRUE}
mae(dki_test$Penambahan_Harian_Kasus_Terkonf,dki_test$prediction)
mape(dki_test$Penambahan_Harian_Kasus_Terkonf,dki_test$prediction)
mase(dki_test$Penambahan_Harian_Kasus_Terkonf,dki_test$prediction)
rmse(dki_test$Penambahan_Harian_Kasus_Terkonf,dki_test$prediction)
```
